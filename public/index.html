<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentinel - Infrastructure Monitor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
      background: #0d1117;
      color: #c9d1d9;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #21262d;
    }
    .header h1 { color: #58a6ff; }
    .header .status-indicator { font-size: 0.9rem; }
    .status-ok { color: #3fb950; }
    .status-warn { color: #d29922; }
    .status-error { color: #f85149; }

    /* Section layout */
    .section {
      background: #161b22;
      border: 1px solid #21262d;
      border-radius: 6px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
    }
    .section h2 {
      color: #58a6ff;
      font-size: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Summary bar */
    .summary-bar {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .summary-stat {
      text-align: center;
    }
    .summary-stat .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .summary-stat .label {
      font-size: 0.75rem;
      color: #8b949e;
      text-transform: uppercase;
    }

    /* Task list */
    .task-list { list-style: none; }
    .task-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #21262d;
      font-size: 0.875rem;
    }
    .task-item:last-child { border-bottom: none; }
    .task-id {
      color: #8b949e;
      font-size: 0.8rem;
      min-width: 3rem;
    }
    .task-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .task-project {
      color: #8b949e;
      font-size: 0.8rem;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Status badges */
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-in_progress { background: #1f6feb33; color: #58a6ff; border: 1px solid #1f6feb; }
    .badge-todo { background: #8b949e22; color: #8b949e; border: 1px solid #8b949e55; }
    .badge-blocked { background: #f8514933; color: #f85149; border: 1px solid #f85149; }
    .badge-done { background: #3fb95033; color: #3fb950; border: 1px solid #3fb950; }

    /* Priority badges */
    .priority-critical { color: #f85149; font-weight: bold; }
    .priority-high { color: #d29922; }
    .priority-medium { color: #8b949e; }
    .priority-low { color: #484f58; }

    /* Project cards */
    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.75rem;
    }
    .project-card {
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 6px;
      padding: 0.75rem 1rem;
    }
    .project-card .project-name {
      font-weight: 600;
      color: #c9d1d9;
      margin-bottom: 0.25rem;
    }
    .project-card .project-status {
      font-size: 0.75rem;
      color: #8b949e;
      margin-bottom: 0.5rem;
    }
    .project-card .task-counts {
      display: flex;
      gap: 0.75rem;
      font-size: 0.8rem;
    }
    .task-counts .count-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    .dot-progress { background: #1f6feb; }
    .dot-todo { background: #8b949e; }
    .dot-blocked { background: #f85149; }
    .dot-done { background: #3fb950; }

    /* Activity feed */
    .activity-feed { list-style: none; }
    .activity-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid #21262d;
      font-size: 0.875rem;
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-time {
      color: #484f58;
      font-size: 0.75rem;
    }
    .activity-project {
      color: #58a6ff;
      font-size: 0.8rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #21262d;
    }
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      color: #8b949e;
      border-bottom: 2px solid transparent;
      font-size: 0.875rem;
      transition: color 0.15s;
    }
    .tab:hover { color: #c9d1d9; }
    .tab.active {
      color: #58a6ff;
      border-bottom-color: #58a6ff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stale warning */
    .stale-warning {
      background: #d2992215;
      border: 1px solid #d2992255;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
      color: #d29922;
    }

    /* Loading / error states */
    .loading { color: #8b949e; font-style: italic; }
    .error-msg { color: #f85149; }

    /* Existing pre block for raw status */
    pre {
      background: #161b22;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      overflow-x: auto;
      font-size: 0.85rem;
    }

    /* Two-column layout for forge section */
    .forge-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .forge-columns { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Sentinel</h1>
    <span class="status-indicator" id="conn-status">
      <span class="status-ok" id="status">Connecting...</span>
    </span>
  </div>

  <!-- System status (existing) -->
  <div class="section" id="system-section">
    <h2>System Status</h2>
    <pre id="output">Loading...</pre>
  </div>

  <!-- ForgeTeam Activity -->
  <div class="section" id="forge-section">
    <h2>ForgeTeam Activity</h2>

    <div id="forge-summary" class="summary-bar"></div>

    <div id="forge-stale"></div>

    <div class="tabs">
      <div class="tab active" data-tab="active-tasks">Active Tasks</div>
      <div class="tab" data-tab="projects">Projects</div>
      <div class="tab" data-tab="recent-activity">Recent Activity</div>
      <div class="tab" data-tab="open-questions">Open Questions</div>
    </div>

    <!-- Active Tasks tab -->
    <div class="tab-content active" id="tab-active-tasks">
      <ul class="task-list" id="forge-tasks">
        <li class="loading">Loading tasks...</li>
      </ul>
    </div>

    <!-- Projects tab -->
    <div class="tab-content" id="tab-projects">
      <div class="project-grid" id="forge-projects">
        <span class="loading">Loading projects...</span>
      </div>
    </div>

    <!-- Recent Activity tab -->
    <div class="tab-content" id="tab-recent-activity">
      <div class="forge-columns">
        <div>
          <h3 style="font-size:0.875rem; color:#8b949e; margin-bottom:0.5rem;">Recent Completions</h3>
          <ul class="activity-feed" id="forge-completions">
            <li class="loading">Loading...</li>
          </ul>
        </div>
        <div>
          <h3 style="font-size:0.875rem; color:#8b949e; margin-bottom:0.5rem;">Recent Decisions</h3>
          <ul class="activity-feed" id="forge-decisions">
            <li class="loading">Loading...</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Open Questions tab -->
    <div class="tab-content" id="tab-open-questions">
      <ul class="activity-feed" id="forge-questions">
        <li class="loading">Loading...</li>
      </ul>
    </div>
  </div>

  <script>
    // -- Existing system status --
    async function fetchStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        document.getElementById('status').textContent = 'Connected';
        document.getElementById('status').className = 'status-ok';
      } catch (err) {
        document.getElementById('status').textContent = 'Error: ' + err.message;
        document.getElementById('status').className = 'status-error';
      }
    }
    fetchStatus();

    // SSE for real-time updates
    const evtSource = new EventSource('/api/events');
    evtSource.addEventListener('metrics', (e) => {
      document.getElementById('output').textContent = e.data;
    });
    evtSource.addEventListener('forge-update', () => {
      loadForgeTasks();
      loadForgeActivity();
    });
    evtSource.onerror = () => {
      document.getElementById('status').textContent = 'SSE disconnected - reconnecting...';
      document.getElementById('status').className = 'status-warn';
    };

    // -- Tab switching --
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // -- Helpers --
    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const now = new Date();
      const then = new Date(dateStr.replace(' ', 'T') + 'Z');
      const diffMs = now - then;
      const mins = Math.floor(diffMs / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      return days + 'd ago';
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // -- ForgeTeam: Tasks --
    async function loadForgeTasks() {
      try {
        const res = await fetch('/api/forge/tasks');
        if (!res.ok) throw new Error('API returned ' + res.status);
        const data = await res.json();

        // Summary bar
        const summary = data.summary || {};
        document.getElementById('forge-summary').innerHTML = [
          { label: 'In Progress', value: summary.in_progress || 0, cls: 'status-ok' },
          { label: 'Todo', value: summary.todo || 0, cls: '' },
          { label: 'Blocked', value: summary.blocked || 0, cls: 'status-error' },
          { label: 'Done', value: summary.done || 0, cls: 'status-ok' },
        ].map(s => `
          <div class="summary-stat">
            <div class="value ${s.cls}">${s.value}</div>
            <div class="label">${s.label}</div>
          </div>
        `).join('');

        // Task list
        const list = document.getElementById('forge-tasks');
        if (!data.tasks || data.tasks.length === 0) {
          list.innerHTML = '<li class="task-item" style="color:#8b949e">No active tasks</li>';
          return;
        }
        list.innerHTML = data.tasks.map(t => `
          <li class="task-item">
            <span class="task-id">#${t.id}</span>
            <span class="badge badge-${t.status}">${t.status.replace('_', ' ')}</span>
            <span class="task-title" title="${escapeHtml(t.title)}">${escapeHtml(t.title)}</span>
            <span class="task-project" title="${escapeHtml(t.project_name)}">${escapeHtml(t.project_codename || t.project_name)}</span>
            <span class="priority-${t.priority}">${t.priority || ''}</span>
          </li>
        `).join('');
      } catch (err) {
        document.getElementById('forge-tasks').innerHTML =
          '<li class="error-msg">Failed to load tasks: ' + escapeHtml(err.message) + '</li>';
        document.getElementById('forge-summary').innerHTML = '';
      }
    }

    // -- ForgeTeam: Activity --
    async function loadForgeActivity() {
      try {
        const res = await fetch('/api/forge/activity?limit=15');
        if (!res.ok) throw new Error('API returned ' + res.status);
        const data = await res.json();

        // Stale items warning
        const staleEl = document.getElementById('forge-stale');
        if (data.stale_items && data.stale_items.length > 0) {
          staleEl.innerHTML = `
            <div class="stale-warning">
              ${data.stale_items.length} stale task(s) in_progress for 24h+:
              ${data.stale_items.map(s =>
                `#${s.id} ${escapeHtml(s.title)} (${escapeHtml(s.project_codename || s.project_name)})`
              ).join(', ')}
            </div>`;
        } else {
          staleEl.innerHTML = '';
        }

        // Recent completions
        const compEl = document.getElementById('forge-completions');
        if (!data.recent_completions || data.recent_completions.length === 0) {
          compEl.innerHTML = '<li style="color:#8b949e">No recent completions</li>';
        } else {
          compEl.innerHTML = data.recent_completions.map(c => `
            <li class="activity-item">
              <span class="activity-project">${escapeHtml(c.project_codename || c.project_name)}</span>
              #${c.id} ${escapeHtml(c.title)}
              <span class="activity-time">${timeAgo(c.completed_at)}</span>
            </li>
          `).join('');
        }

        // Recent decisions
        const decEl = document.getElementById('forge-decisions');
        if (!data.recent_decisions || data.recent_decisions.length === 0) {
          decEl.innerHTML = '<li style="color:#8b949e">No recent decisions</li>';
        } else {
          decEl.innerHTML = data.recent_decisions.map(d => `
            <li class="activity-item">
              <span class="activity-project">${escapeHtml(d.project_codename || d.project_name)}</span>
              ${escapeHtml(d.topic)}: ${escapeHtml(d.decision)}
              <span class="activity-time">${timeAgo(d.decided_at)}</span>
            </li>
          `).join('');
        }

        // Open questions
        const qEl = document.getElementById('forge-questions');
        if (!data.open_questions || data.open_questions.length === 0) {
          qEl.innerHTML = '<li style="color:#8b949e">No open questions</li>';
        } else {
          qEl.innerHTML = data.open_questions.map(q => `
            <li class="activity-item">
              <span class="activity-project">${escapeHtml(q.project_codename || q.project_name)}</span>
              <span class="priority-${q.priority || 'medium'}">[${q.priority || 'medium'}]</span>
              ${escapeHtml(q.question)}
              <span class="activity-time">${timeAgo(q.asked_at)}</span>
            </li>
          `).join('');
        }

        // Projects (from activity endpoint's active_projects)
        const projEl = document.getElementById('forge-projects');
        if (!data.active_projects || data.active_projects.length === 0) {
          projEl.innerHTML = '<span style="color:#8b949e">No active projects</span>';
        } else {
          projEl.innerHTML = data.active_projects.map(p => `
            <div class="project-card">
              <div class="project-name">${escapeHtml(p.codename || p.name)}</div>
              <div class="project-status">${escapeHtml(p.name)} - ${p.status || 'unknown'}</div>
              <div class="task-counts">
                ${p.in_progress_count > 0 ? `<span class="count-item"><span class="dot dot-progress"></span>${p.in_progress_count} active</span>` : ''}
                ${p.todo_count > 0 ? `<span class="count-item"><span class="dot dot-todo"></span>${p.todo_count} todo</span>` : ''}
                ${p.blocked_count > 0 ? `<span class="count-item"><span class="dot dot-blocked"></span>${p.blocked_count} blocked</span>` : ''}
                ${p.done_count > 0 ? `<span class="count-item"><span class="dot dot-done"></span>${p.done_count} done</span>` : ''}
              </div>
            </div>
          `).join('');
        }
      } catch (err) {
        document.getElementById('forge-completions').innerHTML =
          '<li class="error-msg">Failed to load: ' + escapeHtml(err.message) + '</li>';
      }
    }

    // Initial load
    loadForgeTasks();
    loadForgeActivity();

    // Refresh every 60 seconds
    setInterval(() => { loadForgeTasks(); loadForgeActivity(); }, 60000);
  </script>
</body>
</html>
